<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/menu_layout}">
<head>
    <title>스케줄 수정</title>
    <link th:href="@{/css/manager_list.css}" rel="stylesheet"/>
    <!-- jquery CDN -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- fullcalendar CDN -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.8.0/main.min.css' rel='stylesheet'/>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.8.0/main.min.js'></script>
    <!-- fullcalendar 언어 CDN -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.8.0/locales-all.min.js'></script>
    <script>

        var calendar = null;
        var initialLocaleCode = 'ko';
        var localeSelectorEl = document.getElementById('locale-selector');

            $(document).ready(function (){

                    var calendarEl = document.getElementById('calendar');
                    calendar = new FullCalendar.Calendar(calendarEl, {
                        initialDate: '2022-02-07',
                        initialView: 'timeGridWeek',
                        headerToolbar: {
                            left: 'prev,next today',
                            center: 'title',
                            right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
                        },
                        navLinks: true,
                        editable: true,
                        selectable: true,
                        droppable: true, // this allows things to be dropped onto the calendar

                        eventAdd: function () { // 이벤트가 추가되면 발생하는 이벤트
                            console.log()
                        },

                        // eventChange: function (obj) { // 이벤트가 수정되면 발생하는 이벤트
                        //     allEvent = calendar.getEvents();
                        //     console.log(allEvent);
                        // },
                        eventRemove: function (obj) { // 이벤트가 삭제되면 발생하는 이벤트

                        },
                        /**
                         * 드래그로 이벤트 추가하기
                         */
                        select: function (arg) { // 캘린더에서 이벤트를 생성할 수 있다.

                            var title = prompt('일정을 입력해주세요.');
                            if (title) {
                                calendar.addEvent({
                                    title: title,
                                    start: arg.start,
                                    end: arg.end,
                                    allDay: arg.allDay,
                                })
                            }

                            var allEvent = calendar.getEvents(); // .getEvents() 함수로 모든 이벤트를 Array 형식으로 가져온다. (FullCalendar 기능 참조)

                            var events = new Array(); // Json 데이터를 받기 위한 배열 선언
                            for (var i = 0; i < allEvent.length; i++) {
                                var obj = new Object();     // Json 을 담기 위해 Object 선언
                                // alert(allEvent[i]._def.title); // 이벤트 명칭 알람
                                obj.title = allEvent[i]._def.title; // 이벤트 명칭  ConsoleLog 로 확인 가능.
                                obj.start = allEvent[i]._instance.range.start; // 시작
                                obj.end = allEvent[i]._instance.range.end; // 끝

                                events.push(obj);
                            }
                            var jsondata = JSON.stringify(events);
                            console.log(jsondata);
                            // saveData(jsondata);

                            $(function saveData(jsondata) {
                                $.ajax({
                                    url: "/full-calendar/calendar-admin-update",
                                    method: "POST",
                                    dataType: "json",
                                    data: JSON.stringify(events),
                                    contentType: 'application/json',
                                })
                                    .done(function (result) {
                                        // alert(result);
                                    })
                                    .fail(function (request, status, error) {
                                         // alert("에러 발생" + error);
                                    });
                                calendar.unselect()
                            });
                        },


                        eventClick: function (info){
                            if(confirm("일정'"+ info.event.title +"'을 삭제하시겠습니까 ?")){
                                // 확인 클릭 시
                                info.event.remove();
                                console.log(info);
                            }

                            var deleteEvents = calendar.getEvents();
                            var events = new Array(); // Json 데이터를 받기 위한 배열 선언
                            for (var i = 0; i < deleteEvents.length; i++) {
                                var obj = new Object();
                                obj.title = deleteEvents[i]._def.title;
                                events.push(obj);
                            }
                            console.log(obj);
                            $(function deleteData(){
                                $.ajax({
                                    url: "/full-calendar/calendar-admin-update",
                                    method: "DELETE",
                                    dataType: "json",
                                    data: JSON.stringify(events),
                                    contentType: 'application/json',
                                })
                            })
                        }

                        // drop: function (arg) {
                        //     // is the "remove after drop" checkbox checked?
                        //     if (document.getElementById('drop-remove').checked) {
                        //         // if so, remove the element from the "Draggable Events" list
                        //         arg.draggedEl.parentNode.removeChild(arg.draggedEl);
                        //     }
                        // }
                    });
                    calendar.render();
        });




    </script>
    <style>
        body {
            font-family: Arial, Helvetica Neue, Helvetica, sans-serif;
            font-size: 14px;
        }

        table {
            text-align: left;
        }

        .access_user {
            width: 300px;
            height: 100px;
            float: right;
            margin-right: 100px;
            padding-top: 50px;
        }

        #external-events {
            position: absolute;
            /*left: 100 px;*/
            /*top: 100px;*/
            width: 150px;
            overflow: hidden;
            padding: 0 10px;
            margin-top: 80px;
            border: 1px solid #ccc;
            background: #eee;
            text-align: left;
        }

        #external-events h4 {
            font-size: 16px;
            margin-top: 0;
            padding-top: 1em;
        }

        #external-events .fc-event {
            margin: 3px 0;
            cursor: move;
        }

        #external-events p {
            margin: 1.5em 0;
            font-size: 11px;
            color: #666;
        }

        #external-events p input {
            margin: 0;
            vertical-align: middle;
        }

        #calendar-wrap {
            margin-left: 200px;
        }

        #calendar {
            max-width: 1100px;
            margin: 40px auto;
            padding: 0 10px;
        }
    </style>

</head>

<th:block layout:fragment="ground-wrap">
    <div class="ground">
        <div class="main">
            <div class="title1">
                <h1>스케줄 수정</h1>
            </div>
                <div id='calendar-wrap'>
                    <div id='calendar'></div>
                </div>
            </div>
        </div>
    </div>

    <script src="fullcalendar/lib/locales-all.js"></script>

    <script>
        var calendarEl = document.getElementById('calendar');

        var calendar = new FullCalendar.Calendar(calendarEl, {
            plugins: ["dayGrid"]
            , locale: "ko"
        });

    </script>

    <script>
        // 기본 위치(top)값
        var floatPosition = parseInt($("#external-events").css('top'))

        // scroll 인식
        $(window).scroll(function () {
            // 현재 스크롤 위치
            var currentTop = $(window).scrollTop();
            var bannerTop = currentTop + floatPosition + "px";

            //이동 애니메이션
            $("#external-events").stop().animate({
                "top": bannerTop
            }, 500);
        }).scroll();
    </script>
</th:block>
</html>